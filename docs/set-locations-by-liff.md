# # LINE Bot 地點設定功能規格文件（LIFF 方案）

## 專案概述

為 LINE Bot 天氣查詢服務實作「住家/公司地點設定」功能，採用 LIFF（LINE Front-end Framework）方案，將設定介面以網頁表單形式整合於 LINE 聊天室內。

### 核心需求
- 使用者可設定「住家」和「公司」的行政區資訊
- 資料格式：縣市 + 行政區（如：新北市 永和區）
- 設定完成後存入資料庫，供後續天氣查詢使用
- 與現有 Rich Menu 整合，提供流暢的使用體驗

## 技術方案選擇理由

### 為什麼選擇 LIFF 而非 Quick Reply
1. **資料正確性**：表單驗證比多回合點選更可靠
2. **使用體驗**：一次填完比多次點選更直觀
3. **擴展性**：未來可輕鬆加入門牌、經緯度等欄位
4. **維護性**：前後端分離，行政區資料更新不影響對話流程

### 為什麼前後端放同一 Repo
1. **簡化部署**：避免多套基礎設施
2. **降低複雜度**：CORS、域名、SSL 都在同一環境
3. **快速上線**：MVP 階段優先功能實現，不追求架構完美
4. **成本考量**：單人開發，避免過度工程化

## 系統架構

### 檔案結構設計
```
your-bot/
├─ app/                     # 既有 FastAPI 應用
│  ├─ main.py
│  ├─ routes/
│  └─ models/
├─ static/                  # 新增：靜態檔案目錄
│  └─ liff/
│     └─ location/
│        ├─ index.html      # LIFF 主頁面
│        ├─ app.js          # 前端邏輯
│        └─ style.css       # 樣式
├─ data/                    # 新增：資料檔案
│  └─ tw_admin_divisions.json
└─ requirements.txt
```

### 服務架構
1. **FastAPI 服務**：既有後端 + 新增 LIFF 靜態檔案服務 + 新增地點設定 API
2. **LIFF 前端**：純前端頁面，使用 vanilla JS（避免複雜打包流程）
3. **LINE Platform**：Rich Menu → LIFF → 回傳訊息

## 功能流程設計

### 主要使用者流程
1. 使用者點擊 Rich Menu「⚙️ 設定」
2. 開啟 LIFF 頁面（內嵌於 LINE 聊天室）
3. 選擇設定類型（住家/公司）
4. 選擇縣市（下拉選單）
5. 選擇行政區（根據縣市動態載入）
6. 提交表單
7. LIFF 發送確認訊息回聊天室
8. 關閉 LIFF 頁面

### 錯誤處理流程
- ID Token 驗證失敗：顯示錯誤訊息，不關閉 LIFF
- 網路請求失敗：顯示重試提示
- 資料驗證失敗：即時表單驗證提示

## 技術實作規格

### 1. LINE Platform 設定
- **LIFF App 建立**：在 Messaging API Channel 下新增 LIFF 應用
- **Endpoint URL**：`https://你的域名/liff/location/`
- **Size**：Full（全螢幕體驗）
- **Scope**：`openid`, `profile`（取得使用者身份）

### 2. Rich Menu 整合
- **「⚙️ 設定」按鈕**：URI action 指向 LIFF URL
- **URL 參數**：可帶 `?target=home` 或 `?target=work` 預設選項
- **未設定情境**：點選「🏠 住家」或「🏢 公司」時，若未設定則導向 LIFF

### 3. 前端 LIFF 頁面規格

#### 表單元件
- **目標選擇**：Radio Button（住家/公司）
- **縣市選擇**：Select 下拉選單（22 個選項）
- **行政區選擇**：Select 下拉選單（根據縣市動態載入）
- **提交按鈕**：送出設定

#### 前端邏輯
- **LIFF SDK 初始化**：取得 ID Token 和使用者資訊
- **表單驗證**：必填欄位檢查、行政區與縣市對應檢查
- **動態載入**：縣市選擇改變時更新行政區選項
- **API 呼叫**：將表單資料與 ID Token 發送到後端
- **回饋機制**：成功後發送訊息到聊天室並關閉 LIFF

### 4. 後端 API 規格

#### 新增 API 端點
- **路徑**：`POST /api/user/locations`
- **功能**：接收並驗證地點設定資料
- **輸入格式**：
  ```json
  {
    "id_token": "LINE_ID_TOKEN",
    "target": "home|work",
    "city": "縣市名稱",
    "district": "行政區名稱"
  }
  ```

#### 身份驗證機制
- **ID Token 驗證**：使用 LINE OIDC 公鑰驗證 JWT
- **使用者映射**：維護 OpenID `sub` 與 LINE `userId` 的對應關係
- **安全性**：驗證 token 簽章、發行者、有效期限

#### 資料驗證
- **行政區白名單**：對照台灣行政區資料檢查合法性
- **輸入格式**：字串長度、特殊字元過濾
- **重複設定**：允許覆蓋既有設定

### 5. 資料庫設計

#### user_locations 表格擴充
- 新增欄位：`home_city`, `home_district`, `work_city`, `work_district`
- 索引：`user_id` 主鍵
- 約束：`city` 和 `district` 組合必須在行政區白名單內

#### 行政區資料管理
- **檔案格式**：JSON 格式儲存完整台灣行政區對應
- **資料結構**：
  ```json
  {
    "新北市": ["永和區", "中和區", "板橋區", ...],
    "台北市": ["大安區", "信義區", "中正區", ...]
  }
  ```
- **同步機制**：前後端共用同一份資料源

### 6. 靜態檔案服務
- **FastAPI StaticFiles**：掛載 `/liff/` 路徑到 `static/liff/` 目錄
- **HTML 支援**：啟用 `html=True` 支援目錄索引
- **快取策略**：靜態資源加上適當的 Cache-Control header

## 安全性考量

### 身份驗證
- **ID Token 驗證**：確保請求來自合法 LINE 使用者
- **重放攻擊防護**：檢查 token 有效期限
- **來源驗證**：限制 CORS 允許來源

### 資料保護
- **輸入驗證**：所有使用者輸入必須經過白名單驗證
- **SQL 注入防護**：使用 ORM 參數化查詢
- **Rate Limiting**：同一使用者限制請求頻率

## 部署規格

### 環境需求
- **HTTPS 必須**：LIFF 要求安全連線
- **SSL 憑證**：Let's Encrypt 或商業憑證
- **網域設定**：確保 LIFF endpoint URL 可正常存取

### 部署步驟
1. 更新 FastAPI 應用，新增靜態檔案路由和 API 端點
2. 上傳 LIFF 前端檔案到 `static/liff/location/`
3. 上傳行政區資料檔案
4. 在 LINE Developers Console 建立 LIFF 應用
5. 更新 Rich Menu 設定

### 監控指標
- **LIFF 開啟率**：Rich Menu 點擊 → LIFF 頁面載入
- **設定完成率**：LIFF 開啟 → 成功提交表單
- **錯誤率**：API 回應錯誤比例
- **使用分佈**：住家 vs 公司設定比例

## 測試策略

### 功能測試
- **表單驗證**：各種輸入組合的正確性檢查
- **API 整合**：LIFF 與後端 API 的完整流程測試
- **LINE 整合**：Rich Menu → LIFF → 訊息回饋的端到端測試

### 安全測試
- **身份偽造**：嘗試使用偽造的 ID Token
- **資料注入**：測試各種惡意輸入的處理
- **權限檢查**：確保使用者只能設定自己的資料

## 未來擴展考量

### 功能擴展
- **多地點支援**：除住家/公司外增加自訂地點
- **地址詳細資訊**：街道門牌、地標名稱
- **地圖整合**：地點選擇視覺化
- **通知設定**：特定地點的天氣警報

### 架構演進
- **前端分離**：當功能複雜化時可抽出獨立 Repository
- **CDN 加速**：靜態資源使用 CDN 分發
- **國際化**：支援多語言介面
- **PWA 化**：離線功能支援

## 成功指標

### 技術指標
- LIFF 頁面載入時間 < 2 秒
- API 回應時間 < 500ms
- 設定成功率 > 95%
- 錯誤率 < 1%

### 業務指標
- 使用者設定完成率 > 80%
- 設定後天氣查詢使用率提升
- 使用者滿意度回饋
