# LINE Bot 地點設定功能開發規格書

## 專案資訊
- **分支**：feature/liff-location-settings（在此分支進行 User 欄位擴充）
- **預期完成時間**：45-75 分鐘
- **完成標準**：使用者設定完成後資料成功儲存到資料庫

## 1. 問題背景（Why）

### 核心需求
WeaMind LINE Bot 需要提供「住家/公司地點設定」功能，讓使用者能夠：
- 設定常用地點（住家、公司）
- 後續透過 Rich Menu 一鍵查詢天氣
- 提升使用者體驗，減少重複輸入地址的麻煩

### 現況限制
- Rich Menu（Todo #24）尚未實作，無法提供原計劃的觸發入口
- User 資料表缺少地點欄位，無法儲存使用者設定
- 缺少 LINE ID Token 驗證機制，無法確保 LIFF 請求的安全性

### 解決方案
採用**分階段實作**策略：
1. **第一階段**：用文字指令「設定地點」觸發 LIFF 功能
2. **第二階段**：完成 Rich Menu 後整合正式觸發機制

## 2. 功能需求（What）

### 2.1 核心功能
- 使用者輸入「設定地點」四字，Bot 回覆 LIFF 連結
- LIFF 頁面提供表單設定住家/公司地點
- 支援台灣 22 縣市 368 個行政區的選擇
- 設定完成後回傳確認訊息至 LINE 聊天室

### 2.2 資料流程
```
用戶輸入「設定地點」→ Bot 回覆 LIFF URL → 開啟 LIFF 頁面
                                              ↓
用戶選擇地點類型（住家/公司）→ 選擇縣市（一級行政區）
                                              ↓
縣市選擇完成 → 行政區選單自動更新 → 選擇行政區（二級行政區）
                                              ↓
提交表單 → 後端驗證 ID Token → 更新資料庫 → 回傳成功訊息
```

### 2.3 使用者體驗
- **觸發方式**：文字指令「設定地點」
- **介面**：LIFF 全螢幕頁面，內嵌於 LINE 聊天室
- **表單元件**：
  - Radio Button（地點類型選擇：住家/公司）
  - 兩層式下拉選單：
    - **第一層**：縣市選擇（一級行政區，22 個選項）
    - **第二層**：行政區選擇（二級行政區，根據第一層動態載入）
- **互動邏輯**：選擇縣市後自動更新行政區選項
- **回饋機制**：設定成功後自動發送確認訊息並關閉 LIFF

## 3. 技術方案（How）

### 3.1 系統架構

#### 檔案結構
```
WeaMind/
├─ app/
│  ├─ user/
│  │  ├─ models.py          # 新增地點欄位
│  │  └─ service.py         # 地點設定相關方法
│  ├─ line/
│  │  └─ service.py         # 新增「設定地點」文字處理
│  └─ main.py               # 新增靜態檔案路由
├─ static/                  # 新建目錄
│  ├─ data/
│  │  └─ tw_admin_divisions.json  # ✅ 已完成
│  └─ liff/
│     └─ location/
│        ├─ index.html      # LIFF 主頁面
│        ├─ app.js          # 前端邏輯
│        └─ style.css       # 樣式
└─ migrations/
   └─ versions/
      └─ [new]_add_user_location_fields.py  # 資料庫遷移
```

#### 部署資訊
- **網域**：api.kyomind.tw（已有 HTTPS）
- **LIFF URL**：`https://api.kyomind.tw/liff/location/`
- **靜態檔案服務**：FastAPI StaticFiles

### 3.2 資料庫設計

#### User 模型擴展（在本分支實作）
新增兩個欄位到 User 表格：
- `home_location_id`：住家地點 ID（外鍵至 location.id）
- `work_location_id`：公司地點 ID（外鍵至 location.id）

兩個欄位都允許 NULL，使用者可選擇性設定。

### 3.3 API 設計

#### 新增端點：POST /api/user/locations
接收 LIFF 提交的地點設定，驗證 LINE ID Token 後更新資料庫。

**重要**：必須確保資料成功儲存到資料庫，這是本分支的完成標準。

### 3.4 前端 LIFF 實作

LIFF 頁面需要：
1. 載入台灣行政區資料（已準備：`static/data/tw_admin_divisions.json`）
2. 提供地點類型選擇（住家/公司）和**兩層式地點選單**：
   - **第一層**：縣市選擇（一級行政區，22 個選項）
   - **第二層**：行政區選擇（二級行政區，根據縣市動態載入）
3. 取得 LINE ID Token 並提交到後端 API
4. 設定成功後發送確認訊息並關閉 LIFF

**使用者操作流程**：
1. 選擇地點類型（住家/公司）
2. 選擇縣市（一級行政區下拉選單）
3. 縣市選擇後，行政區選單自動更新為該縣市的所有行政區
4. 選擇具體行政區（二級行政區）
5. 提交表單

**關鍵**：確保表單資料能正確傳送到後端並儲存到資料庫。

## 4. 實作重點

### 4.1 必要步驟
1. **資料庫遷移**：新增 User 表格的兩個地點欄位
2. **LINE ID Token 驗證**：確保請求安全性
3. **LIFF 前端頁面**：表單介面和 JavaScript 邏輯
   - 實作兩層式選單：縣市選擇 → 動態載入行政區選項
   - 確保使用者必須先選縣市，再選行政區的操作順序  
4. **API 端點**：接收並處理地點設定請求
5. **資料庫儲存**：確保設定成功寫入資料庫（完成標準）

### 4.2 LINE Bot 文字觸發
使用者輸入「設定地點」時，回覆 LIFF 連結：`https://api.kyomind.tw/liff/location/`

### 4.3 靜態檔案服務
FastAPI 需掛載靜態檔案路由，讓 LIFF 頁面和行政區資料可被存取。

## 5. 關鍵技術考量

### 5.1 資料庫完整性
- 確保地點設定能正確對應到現有的 location 表格
- 外鍵約束確保資料一致性

### 5.2 安全性要點  
- LINE ID Token 驗證防止偽造請求
- 行政區白名單驗證防止無效資料

### 5.3 開發提醒
- API 路由函數請求參數命名為 `payload`
- 所有新函數需要 docstring
- 提交訊息保持簡潔（10 字以內）

## 6. 重要決策

1. **觸發方式**：文字指令「設定地點」（避免 Rich Menu 相依性）
2. **分支策略**：在 feature/liff-location-settings 分支進行 User 欄位擴充
3. **完成標準**：資料成功儲存到資料庫（可自行查詢 DB 驗證）
4. **資料結構**：使用外鍵關聯現有 location 表格

---

**AI Agent 開發指引**：
專案已具備完整基礎架構，行政區資料已準備完成。請按照上述規格實作各模組，重點確保使用者設定能成功寫入資料庫。

## 7. 驗收標準

### 7.1 核心驗收（必須完成）
- [ ] 使用者輸入「設定地點」能收到 LIFF 連結
- [ ] LIFF 頁面正常開啟並可選擇地點類型（住家/公司）
- [ ] 縣市下拉選單正確載入 22 個一級行政區選項
- [ ] 選擇縣市後，行政區下拉選單自動更新為對應的二級行政區
- [ ] 表單提交後**資料成功儲存到資料庫**（主要驗收標準）
- [ ] 設定完成後在聊天室收到確認訊息

### 7.2 技術驗收
- [ ] User 模型新增兩個地點欄位並完成遷移
- [ ] ID Token 驗證機制正常運作
- [ ] 行政區資料驗證機制運作正常
