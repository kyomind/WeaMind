# AGENT-migrate-tests-to-postgresql.md

## ğŸ¯ Mission Statement
**å°‡å–®å…ƒæ¸¬è©¦è³‡æ–™åº«å¾ SQLite å®Œå…¨é·ç§»è‡³ PostgreSQLï¼Œæ¶ˆé™¤è³‡æ–™åº«æ–¹è¨€å·®ç•°ï¼Œç¢ºä¿æ¸¬è©¦ç’°å¢ƒèˆ‡ç”Ÿç”¢ç’°å¢ƒä¸€è‡´ã€‚**

## ğŸ’­ Context & Problem (Why)

### æ ¸å¿ƒå•é¡Œ
- **æ–¹è¨€å·®ç•°é¢¨éšª**ï¼šSQLite å’Œ PostgreSQL åœ¨èªæ³•å’Œè¡Œç‚ºä¸Šå­˜åœ¨å·®ç•°ï¼Œå¯èƒ½å°è‡´æ¸¬è©¦é€šéä½†ç”Ÿç”¢ç’°å¢ƒå‡ºéŒ¯
- **å…·é«”æ¡ˆä¾‹**ï¼š`app/user/service.py` ä¸­çš„ `get_recent_queries` å‡½å¼åˆ»æ„é¿å…ä½¿ç”¨ PostgreSQL çš„ `DISTINCT ON` èªæ³•ï¼Œå› ç‚º SQLite ä¸æ”¯æ´
- **æŠ€è¡“å‚µç´¯ç©**ï¼šç‚ºäº†ç›¸å®¹ SQLiteï¼ŒçŠ§ç‰²äº† PostgreSQL çš„æ•ˆèƒ½å„ªå‹¢

### ç¾æ³åˆ†æ
- æ¸¬è©¦ç’°å¢ƒï¼šSQLite in-memory (`sqlite+pysqlite:///:memory:`)
- ç”Ÿç”¢ç’°å¢ƒï¼šPostgreSQL 17.5 (é€é Docker å®¹å™¨)
- å·²å­˜åœ¨ PostgreSQL å®¹å™¨ï¼šé‹è¡Œåœ¨ port 5433
- CI ç’°å¢ƒï¼šGitHub Actions with uv container

## ğŸ¯ Objectives (What)

### ä¸»è¦ç›®æ¨™
1. **å®Œå…¨ç§»é™¤ SQLite**ï¼šæ¸¬è©¦ä¸å†ä½¿ç”¨ SQLite
2. **çµ±ä¸€è³‡æ–™åº«ç’°å¢ƒ**ï¼šæœ¬åœ°æ¸¬è©¦ã€CIã€ç”Ÿç”¢ç’°å¢ƒéƒ½ä½¿ç”¨ PostgreSQL
3. **æ•ˆèƒ½å„ªåŒ–**ï¼šåˆ©ç”¨ PostgreSQL ç‰¹æ€§æ”¹å–„æŸ¥è©¢æ•ˆèƒ½
4. **ç¶­è­·ç°¡åŒ–**ï¼šç§»é™¤ç’°å¢ƒå·®ç•°è™•ç†é‚è¼¯

### æˆåŠŸæŒ‡æ¨™
- [ ] æ‰€æœ‰æ¸¬è©¦ä½¿ç”¨ PostgreSQL åŸ·è¡Œ
- [ ] CI ç®¡é“æ­£å¸¸é‹ä½œ
- [ ] `get_recent_queries` ä½¿ç”¨ PostgreSQL æœ€ä½³åŒ–èªæ³•
- [ ] æ¸¬è©¦åŸ·è¡Œæ™‚é–“åˆç†ï¼ˆä¸è¶…éåŸæœ¬çš„ 150%ï¼‰

## ğŸ›  Technical Implementation (How)

### Architecture Decision
**é¸æ“‡æ–¹æ¡ˆï¼šGitHub Actions Services + ç¾æœ‰ PostgreSQL å®¹å™¨**
- âœ… ä¸€æ­¥åˆ°ä½ï¼Œé¿å…éæ¸¡æ€§æ–¹æ¡ˆ
- âœ… ç’°å¢ƒä¸€è‡´æ€§
- âœ… ç¶­è­·ç°¡å–®
- âŒ éœ€è¦åŒæ™‚ä¿®æ”¹æœ¬åœ°å’Œ CI é…ç½®

### å¯¦ä½œéšæ®µ

#### éšæ®µä¸€ï¼šæœ¬åœ°æ¸¬è©¦é…ç½® (20-25 åˆ†é˜)
1. **å»ºç«‹æ¸¬è©¦è³‡æ–™åº«**
   - åœ¨ç¾æœ‰ PostgreSQL å®¹å™¨ä¸­å»ºç«‹ `weamind_test` è³‡æ–™åº«
   - ä¸éœ€è¦æ–°çš„å®¹å™¨æˆ–æœå‹™

2. **ä¿®æ”¹æ¸¬è©¦é…ç½®**
   - æ›´æ–° `tests/conftest.py` çš„ `DATABASE_URL`
   - å¯¦ä½œæ¸¬è©¦è³‡æ–™éš”é›¢æ©Ÿåˆ¶

3. **æ¸¬è©¦éš”é›¢ç­–ç•¥**
   - æ¯å€‹æ¸¬è©¦æœƒè©±ï¼š`Base.metadata.create_all()`
   - æ¯å€‹æ¸¬è©¦å¾Œï¼šäº‹å‹™å›æ»¾æˆ– TRUNCATE

#### éšæ®µäºŒï¼šCI é…ç½® (10-15 åˆ†é˜)
1. **GitHub Actions Services**
   - åœ¨ `.github/workflows/ci.yml` æ·»åŠ  PostgreSQL service
   - è¨­å®šå¥åº·æª¢æŸ¥å’Œé€£ç·šåƒæ•¸

2. **ç’°å¢ƒè®Šæ•¸é…ç½®**
   - æ¸¬è©¦å°ˆç”¨çš„è³‡æ–™åº«é€£ç·šè¨­å®š
   - ç¢ºä¿ CI å’Œæœ¬åœ°è¨­å®šä¸€è‡´

#### éšæ®µä¸‰ï¼šæŸ¥è©¢æœ€ä½³åŒ– (10-15 åˆ†é˜)
1. **ä¿®æ”¹ `get_recent_queries`**
   - ä½¿ç”¨ PostgreSQL çš„ `DISTINCT ON`
   - ç§»é™¤ç›¸å®¹æ€§ workaround
   - æ›´æ–°ç›¸é—œ TODO è¨»è§£

### Technical Constraints

#### å¿…é ˆè€ƒæ…®çš„é™åˆ¶
- **å®¹å™¨ä¾è³´**ï¼šæœ¬åœ°æ¸¬è©¦éœ€è¦ PostgreSQL å®¹å™¨é‹è¡Œ
- **CI æœå‹™ä¾è³´**ï¼šCI ç’°å¢ƒéœ€è¦æ·»åŠ  PostgreSQL service é…ç½®
- **æ•ˆèƒ½å½±éŸ¿**ï¼šç›®å‰æ¸¬è©¦åªéœ€ 1 ç§’ï¼ŒPostgreSQL å¯èƒ½å¢åŠ å•Ÿå‹•æ™‚é–“
- **ä¸¦ç™¼æ¸¬è©¦**ï¼šç•¶å‰æ¸¬è©¦é€Ÿåº¦è¶³å¤ å¿«ï¼Œç„¡éœ€è€ƒæ…® pytest-xdist

#### é¢¨éšªç·©è§£
- **å›æ»¾è¨ˆç•«**ï¼šä¿ç•™åŸ SQLite è¨­å®šåœ¨ git history ä¸­
- **æ¼¸é€²é©—è­‰**ï¼šå…ˆåœ¨æœ¬åœ°å®Œæ•´æ¸¬è©¦ï¼Œå†æ¨é€ CI è®Šæ›´
- **ç›£æ§æŒ‡æ¨™**ï¼šæ¸¬è©¦åŸ·è¡Œæ™‚é–“ã€CI æˆåŠŸç‡

## ğŸ§  Memory Hooks (é‡è¦æ±ºç­–è¨˜éŒ„)

### ğŸ’¡ æ ¸å¿ƒæ±ºç­–
> "éæ¸¡æ€§çš„åšæ³•å¸¸å¸¸æ˜¯è‡ªæ‰¾éº»ç…©" - ç”¨æˆ¶æ™ºæ…§
- **æ±ºç­–**ï¼šæ‹’çµ•ç’°å¢ƒè®Šæ•¸æ§åˆ¶ç­–ç•¥ï¼Œé¸æ“‡ä¸€æ­¥åˆ°ä½
- **ç†ç”±**ï¼šé¿å…ç¶­è­·è¤‡é›œçš„æ¢ä»¶é‚è¼¯å’Œç’°å¢ƒå·®ç•°

> "åœ¨ç¾æœ‰ PostgreSQL å®¹å™¨ä¸­å»ºç«‹æ¸¬è©¦è³‡æ–™åº«ï¼Œä¸éœ€è¦æ–°å®¹å™¨"
- **æ±ºç­–**ï¼šæœ¬åœ°ä½¿ç”¨é‚è¼¯è³‡æ–™åº«åˆ†é›¢ï¼ŒCI ä½¿ç”¨ GitHub Actions service
- **ç†ç”±**ï¼šæœ¬åœ°è³‡æºæ•ˆç‡ã€CI ç’°å¢ƒéš”é›¢

> "ç›®å‰æ¸¬è©¦ 1 ç§’å®Œæˆï¼Œç„¡éœ€ pytest-xdist"
- **æ±ºç­–**ï¼šæš«ä¸å¼•å…¥ä¸¦è¡Œæ¸¬è©¦è¤‡é›œæ€§
- **ç†ç”±**ï¼šç•¶å‰æ•ˆèƒ½å·²è¶³å¤ ï¼Œé¿å…éåº¦å·¥ç¨‹åŒ–

### âš ï¸ é¿å…çš„é™·é˜±
- **âŒ æ–°å»º PostgreSQL å®¹å™¨**ï¼šæœ¬åœ°éåº¦è¤‡é›œåŒ–ï¼ˆä½† CI ä»éœ€è¦ serviceï¼‰
- **âŒ ç’°å¢ƒè®Šæ•¸æ§åˆ¶**ï¼šç¶­è­·è² æ“”é«˜
- **âŒ éƒ¨åˆ†é·ç§»**ï¼šå®¹æ˜“ç”¢ç”ŸæŠ€è¡“å‚µ
- **âŒ éåº¦æœ€ä½³åŒ–**ï¼šç›®å‰æ¸¬è©¦ 1 ç§’å®Œæˆï¼Œç„¡éœ€ pytest-xdist

### ğŸ” é—œéµæª”æ¡ˆ
- `tests/conftest.py` - æ¸¬è©¦è³‡æ–™åº«é…ç½®æ ¸å¿ƒ
- `app/user/service.py:get_recent_queries` - å…·é«”çš„æ–¹è¨€å·®ç•°æ¡ˆä¾‹
- `.github/workflows/ci.yml` - CI PostgreSQL service é…ç½®
- `app/core/database.py` - è³‡æ–™åº«é€£ç·šè¨­å®š

### ğŸ¯ æˆåŠŸæ¨¡å¼
```python
# ç›®æ¨™ï¼šå¾é€™æ¨£çš„ workaround
for user_query in query.limit(100):
    if user_query.location_id not in seen_locations:
        # ...æ‰‹å‹•å»é‡é‚è¼¯

# è®Šæˆï¼šç›´æ¥ä½¿ç”¨ PostgreSQL ç‰¹æ€§
query = session.query(UserQuery).distinct(UserQuery.location_id)...
```

## ğŸ“‹ Implementation Checklist

### Pre-flight
- [ ] ç¢ºèª PostgreSQL å®¹å™¨é‹è¡Œç‹€æ…‹
- [ ] æª¢æŸ¥ç›®å‰æ¸¬è©¦è¦†è“‹ç‡ä½œç‚ºåŸºæº–

### Phase 1: Local
- [ ] å»ºç«‹ `weamind_test` è³‡æ–™åº«
- [ ] ä¿®æ”¹ `tests/conftest.py`
- [ ] æ›´æ–°æ‰€æœ‰æ¨¡çµ„çš„ conftest.py
- [ ] æœ¬åœ°åŸ·è¡Œå®Œæ•´æ¸¬è©¦å¥—ä»¶

### Phase 2: CI
- [ ] ä¿®æ”¹ `.github/workflows/ci.yml`
- [ ] æ·»åŠ  PostgreSQL service é…ç½®
- [ ] é©—è­‰ CI æ¸¬è©¦é€šé

### Phase 3: Optimization
- [ ] é‡æ§‹ `get_recent_queries` ä½¿ç”¨ `DISTINCT ON`
- [ ] ç§»é™¤ç›¸é—œ TODO è¨»è§£
- [ ] æ•ˆèƒ½æ¸¬è©¦å’Œæ¯”è¼ƒ

### Post-implementation
- [ ] æ›´æ–°ç›¸é—œæ–‡æª”
- [ ] æ¨™è¨˜æ­¤ TODO ç‚ºå®Œæˆ
- [ ] è€ƒæ…®æ˜¯å¦æœ‰å…¶ä»–é¡ä¼¼çš„æ–¹è¨€ç›¸å®¹æ€§å•é¡Œ

---
*Generated: 2025-09-03*
*Agent: Claude Code*
*Status: Ready for Implementation*
