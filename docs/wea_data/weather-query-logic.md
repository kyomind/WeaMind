# WeaMind 天氣資料查詢邏輯與結果分析

建立日期: 2025-08-13
描述: WeaMind 天氣查詢的完整邏輯分析，包含資料流程、查詢策略與結果格式

## 資料更新流程

### 氣象局 API 特性
- **發布時間**: 每日4次 (05:30, 11:30, 17:30, 23:30)
- **預報範圍**: 未來3天 (72小時)
- **時間區間**: 每3小時一個區間 (00:00, 03:00, 06:00...)
- **查詢限制**: 單次最多5個縣市

### wea-data 微服務更新策略
- **資料來源**: 氣象局開放資料平台 API
- **更新時機**: 氣象局發布後20-30分鐘（如23:30發布，23:45-24:00抓取）
- **資料範圍**: **限定未來27小時（從當下起算，共9筆資料）**
- **寫入邏輯**: 每個行政區寫入9筆資料（27小時÷3小時=9個區間），以作為滑動窗口的緩衝。

### 資料庫寫入特性
```
單次更新流程:
1. 氣象局發布: 2025-08-12 23:30
2. wea-data 開始抓取: 2025-08-12 23:45
3. API 呼叫: 20個一級行政區，共4次API請求（每次5個縣市，最後一次5個）
   - 6個直轄市 + 11個縣 + 3個市 = 20個一級行政區
   - 每次查詢會獲得該縣市下所有鄉鎮市區的資料
4. 資料寫入: 2025-08-12 23:45:00 ~ 23:46:30（約1.5分鐘）
5. 總寫入筆數: 368 × 9 = 3,312筆（全台368個鄉鎮市區）
```

**重要特性**:
- 同一行政區的9筆資料，`fetched_at` 在1-2分鐘內有微小差異
- `start_time` 和 `end_time` 完全固定（00:00, 03:00, 06:00...）
- API 效率高：只需4次請求即可獲得全台灣所有鄉鎮市區資料

## 使用者查詢流程 (最終方案)

此方案旨在確保使用者**任何時候都能看到完整的、未來24小時（8筆）的預報**，完美解決了因資料更新間隔導致的預報時長縮水問題。

### 場景設定
- **使用者輸入**: "新北市永和區"
- **需求**: 顯示未來24小時天氣資料

### 查詢步驟

#### 步驟1: 地點查詢
```sql
SELECT id, full_name
FROM location
WHERE full_name = '新北市永和區';

-- 結果: id = 123, full_name = '新北市永和區'
```

#### 步驟2: 最新資料查詢 (滑動窗口邏輯)
```sql
SELECT
    start_time, end_time,
    weather_condition, weather_emoji,
    precipitation_probability,
    min_temperature, max_temperature
FROM weather
WHERE location_id = 123
  -- 1. 過濾掉已經過期的時段
  AND end_time > NOW()
  -- 2. 確保只從最新的一批資料中選取
  AND fetched_at >= (
    SELECT MAX(fetched_at) - INTERVAL '5 minutes'
    FROM weather
    WHERE location_id = 123
  )
ORDER BY start_time
-- 3. 從剩下的有效預報中，取最前面的8筆
LIMIT 8;
```

**查詢邏輯說明**:
1.  **過濾過期資料 (`end_time > NOW()`)**: 這是實現「滑動窗口」的關鍵。它會自動將已經結束的預報時段（如當前04:00，會過濾掉00:00-03:00的資料）排除掉。
2.  **最新批次資料 (`fetched_at` 窗口)**: 確保我們操作的資料都來自同一次、最新的更新。
3.  **排序與限制 (`ORDER BY` & `LIMIT 8`)**: 從所有尚未過期的、最新批次的預報中，選取接下來的8個時段（24小時）。

這個設計的巧妙之處在於，無論當前時間處於6小時更新週期的哪個點，它都能自動篩選並組合出一個完整的24小時預報，無需複雜的 `CASE` 或 `OFFSET` 邏輯。

## 查詢結果範例

### 模擬資料庫查詢結果

| start_time             | end_time               | weather_condition | emoji | precipitation | min_temp | max_temp | fetched_at             |
| ---------------------- | ---------------------- | ----------------- | ----- | ------------- | -------- | -------- | ---------------------- |
| 2025-08-13 00:00:00+08 | 2025-08-13 03:00:00+08 | 短暫陣雨或雷雨    | 🌦️     | 40            | 27       | 28       | 2025-08-12 23:45:23+08 |
| 2025-08-13 03:00:00+08 | 2025-08-13 06:00:00+08 | 短暫陣雨或雷雨    | 🌦️     | 70            | 26       | 27       | 2025-08-12 23:45:45+08 |
| ... (共9筆資料) ...    |                        |                   |       |               |          |          |                        |
| 2025-08-14 00:00:00+08 | 2025-08-14 03:00:00+08 | 晴時多雲          | ☀️     | 10            | 25       | 28       | 2025-08-12 23:48:30+08 |

### 關鍵觀察

1. **總筆數**: 查詢結果恆為8筆 ✅
2. **時間範圍**: 永遠是從下一個時段起算的24小時 ✅
3. **資料來源**: 永遠來自最新批次的9筆資料 ✅

## LINE Bot 輸出格式

### 根據 PRD v1.0 規格的最終輸出

```text
🗺️ 新北市永和區
📅 08/13 (二)
🌦️ 00:00-03:00：27～28°C／40%
🌦️ 03:00-06:00：26～27°C／70%
⛈️ 06:00-09:00：26°C／80%
⛈️ 09:00-12:00：26°C／80%
☁️ 12:00-15:00：28～32°C／30%
☀️ 15:00-18:00：29～34°C／20%
☁️ 18:00-21:00：28～31°C／30%
☀️ 21:00-00:00：26～29°C／10%

💡 建議：上午雷雨機率高，建議攜帶雨具；下午轉晴，注意防曬與補水。
```

### 格式轉換邏輯

#### 溫度顯示
```python
def format_temperature(min_temp, max_temp):
    if min_temp == max_temp:
        return f"{min_temp}°C"
    else:
        return f"{min_temp}～{max_temp}°C"
```

#### 時間格式
- **時間區間**: 直接使用 `HH:MM-HH:MM` 格式
- **日期顯示**: 月/日 (星期) 格式

#### Emoji 映射
```python
WEATHER_EMOJI_MAP = {
    "晴": "☀️",
    "多雲": "☁️",
    "陰": "☁️",
    "短暫陣雨": "🌦️",
    "陣雨": "🌧️",
    "雷雨": "⛈️",
    "短暫陣雨或雷雨": "🌦️",
    "陣雨或雷雨": "⛈️"
}
```

## 效能考量

### 查詢效能
- **單次查詢**: 1次地點查詢 + 1次天氣資料查詢
- **索引使用**: `location.full_name` 和 `weather(location_id, start_time)`
- **預期回應時間**: < 100ms

### 資料量管控
- **保留期間**: 14天
- **每日資料量**: 13,248筆 (368*9*4)
- **總資料量**: 約185,000筆（可控範圍）

### 清理策略
```sql
-- 每日凌晨2:00執行（避開資料更新時間）
DELETE FROM weather
WHERE fetched_at < NOW() - INTERVAL '14 days';
```

## 邊界條件處理

### 資料不完整情況
1. **少於9筆資料**: 可能是部分更新失敗，查詢邏輯仍能兼容，會顯示最多8筆可用資料。
2. **沒有最新資料**: 使用最近可用的資料，但提示可能不是最新。
3. **同時有多個 fetched_at**: 5分鐘窗口確保獲得完整批次。

### 錯誤處理
1. **地點不存在**: 回到模糊搜尋流程
2. **資料庫連線錯誤**: 友善錯誤提示
3. **資料格式異常**: 使用 raw_description 作為備援

## 總結

這個查詢設計的核心優勢：

1. **體驗一致**: 始終提供完整的24小時預報。
2. **簡潔高效**: 查詢語句清晰，不需複雜的條件分支，效能高。
3. **資料一致性**: 確保所有資料來自同一批次更新。
4. **格式對應**: 查詢結果完美對應 PRD 輸出格式要求。
5. **解耦**: `wea-mind` 的查詢邏輯不需知道 `wea-data` 的具體更新時間，只需依賴資料本身的時間戳，系統更具彈性。

---

**相關文件**:
- `docs/weather-location-schema.sql`
- `docs/weather-location-erd.md`
- `prd/weamind-prd-v1.md`
