-- WeaMind å¤©æ°£èˆ‡è¡Œæ”¿å€è³‡æ–™åº« Schema DDL
-- å»ºç«‹æ—¥æœŸ: 2025-08-12
-- èªªæ˜Ž: åŒ…å«è¡Œæ”¿å€ (locations) å’Œå¤©æ°£é å ± (weather_forecasts) å…©å€‹ä¸»è¦è³‡æ–™è¡¨

-- =============================================================================
-- è¡Œæ”¿å€è³‡æ–™è¡¨
-- =============================================================================
CREATE TABLE location (
    id SERIAL PRIMARY KEY,
    geocode VARCHAR(10) NOT NULL UNIQUE,  -- åœ°ç†ç·¨ç¢¼ï¼Œå¦‚ "10002010"
    county VARCHAR(10) NOT NULL,          -- ç¸£å¸‚åç¨±ï¼Œå¦‚ "æ–°åŒ—å¸‚"
    district VARCHAR(10) NOT NULL,        -- é„‰éŽ®å¸‚å€åç¨±ï¼Œå¦‚ "æ°¸å’Œå€"
    full_name VARCHAR(20) NOT NULL,       -- å®Œæ•´è¡Œæ”¿å€åç¨±ï¼Œå¦‚ "æ–°åŒ—å¸‚æ°¸å’Œå€"ï¼ˆç”¨æ–¼æ¨¡ç³Šæœå°‹ï¼‰
    latitude DECIMAL(9,6),                -- ç·¯åº¦ï¼Œå¦‚ 24.753707
    longitude DECIMAL(9,6),               -- ç¶“åº¦ï¼Œå¦‚ 121.745083
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- åœ°ç†ç·¨ç¢¼ç´¢å¼•ï¼ˆæ°£è±¡å±€ API æŸ¥è©¢æ™‚ä½¿ç”¨ï¼‰
CREATE INDEX idx_location_geocode ON location(geocode);

-- å®Œæ•´åç¨±ç´¢å¼•ï¼ˆç”¨æ–¼æ¨¡ç³Šæœå°‹ï¼Œæ”¯æ´ä½¿ç”¨è€…è¼¸å…¥2-6å€‹å­—ï¼‰
CREATE INDEX idx_location_full_name ON location(full_name);

-- =============================================================================
-- å¤©æ°£é å ±è³‡æ–™è¡¨
-- =============================================================================
CREATE TABLE weather (
    id SERIAL PRIMARY KEY,
    location_id INTEGER NOT NULL REFERENCES location(id),
    start_time TIMESTAMP NOT NULL,        -- é å ±é–‹å§‹æ™‚é–“ï¼ˆå°ç£æ™‚é–“ +08:00ï¼‰
    end_time TIMESTAMP NOT NULL,          -- é å ±çµæŸæ™‚é–“ï¼ˆå°ç£æ™‚é–“ +08:00ï¼‰
    fetched_at TIMESTAMP NOT NULL,        -- è³‡æ–™ç²å–æ™‚é–“ï¼ˆè¨˜éŒ„å¾žæ°£è±¡å±€ API å–å¾—çš„æ™‚é–“ï¼‰
    
    -- è§£æžå¾Œçš„çµæ§‹åŒ–è³‡æ–™ï¼ˆå¯¦éš›ä½¿ç”¨ï¼‰
    weather_condition VARCHAR(30) NOT NULL,  -- å¤©æ°£ç‹€æ³ï¼Œå¦‚ "çŸ­æš«é™£é›¨æˆ–é›·é›¨"
    weather_emoji VARCHAR(10),               -- å°æ‡‰çš„ emoji ç¬¦è™Ÿï¼Œå¦‚ "ðŸŒ¦ï¸"
    precipitation_probability INTEGER CHECK (precipitation_probability >= 0 AND precipitation_probability <= 100), -- é™é›¨æ©ŸçŽ‡ 0-100%
    min_temperature INTEGER,                 -- æœ€ä½Žæº«åº¦ï¼ˆæ”æ°åº¦ï¼‰
    max_temperature INTEGER,                 -- æœ€é«˜æº«åº¦ï¼ˆæ”æ°åº¦ï¼‰
    
    -- åŽŸå§‹è³‡æ–™å‚™æ´ï¼ˆç”¨æ–¼é™¤éŒ¯å’Œé©—è­‰ï¼‰
    raw_description TEXT NOT NULL,          -- åŽŸå§‹ WeatherDescription å­—ä¸²
    
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- ç¢ºä¿åŒä¸€åœ°é»žåŒä¸€æ™‚é–“å€é–“åŒä¸€æ¬¡ç²å–ä¸é‡è¤‡
    CONSTRAINT unique_location_time_fetched UNIQUE (location_id, start_time, end_time, fetched_at)
);

-- å¸¸ç”¨æŸ¥è©¢ç´¢å¼•ï¼šç‰¹å®šåœ°é»žçš„å¤©æ°£é å ±ï¼ˆwea-data å¾®æœå‹™æ›´æ–°æ™‚ä½¿ç”¨ï¼‰
CREATE INDEX idx_weather_location_time ON weather(location_id, start_time);

-- =============================================================================
-- ç¯„ä¾‹è³‡æ–™è¨»è§£
-- =============================================================================

-- location ç¯„ä¾‹è³‡æ–™ï¼š
-- INSERT INTO location (geocode, county, district, full_name, latitude, longitude) VALUES
-- ('10002010', 'å®œè˜­ç¸£', 'å®œè˜­å¸‚', 'å®œè˜­ç¸£å®œè˜­å¸‚', 24.753707, 121.745083),
-- ('10002020', 'å®œè˜­ç¸£', 'ç¾…æ±éŽ®', 'å®œè˜­ç¸£ç¾…æ±éŽ®', 24.678673, 121.758763),
-- ('65000100', 'æ–°åŒ—å¸‚', 'æ°¸å’Œå€', 'æ–°åŒ—å¸‚æ°¸å’Œå€', 25.017891, 121.515406),
-- ('65000010', 'æ–°åŒ—å¸‚', 'æ¿æ©‹å€', 'æ–°åŒ—å¸‚æ¿æ©‹å€', 25.012366, 121.462887);

-- weather ç¯„ä¾‹è³‡æ–™ï¼š
-- INSERT INTO weather (location_id, start_time, end_time, fetched_at, weather_condition, weather_emoji, precipitation_probability, min_temperature, max_temperature, raw_description) VALUES
-- (1, '2025-08-13 00:00:00+08', '2025-08-13 03:00:00+08', '2025-08-12 17:45:00+08', 'çŸ­æš«é™£é›¨æˆ–é›·é›¨', 'ðŸŒ¦ï¸', 40, 27, 28, 'çŸ­æš«é™£é›¨æˆ–é›·é›¨ã€‚é™é›¨æ©ŸçŽ‡40%ã€‚æº«åº¦æ”æ°27è‡³28åº¦ã€‚æ‚¶ç†±ã€‚åå—é¢¨ å¹³å‡é¢¨é€Ÿ<= 1ç´š(æ¯ç§’1å…¬å°º)ã€‚ç›¸å°æ¿•åº¦93è‡³95%ã€‚'),
-- (1, '2025-08-13 00:00:00+08', '2025-08-13 03:00:00+08', '2025-08-12 23:45:00+08', 'çŸ­æš«é™£é›¨æˆ–é›·é›¨', 'ðŸŒ¦ï¸', 50, 26, 28, 'çŸ­æš«é™£é›¨æˆ–é›·é›¨ã€‚é™é›¨æ©ŸçŽ‡50%ã€‚æº«åº¦æ”æ°26è‡³28åº¦ã€‚æ‚¶ç†±ã€‚åå—é¢¨ å¹³å‡é¢¨é€Ÿ<= 1ç´š(æ¯ç§’1å…¬å°º)ã€‚ç›¸å°æ¿•åº¦93è‡³95%ã€‚');

-- =============================================================================
-- è³‡æ–™æ¸…ç†ç­–ç•¥ï¼ˆå»ºè­°æ¯æ—¥å‡Œæ™¨ 2:00 åŸ·è¡Œï¼Œé¿é–‹è³‡æ–™æ›´æ–°æ™‚é–“ï¼‰
-- =============================================================================

-- åˆªé™¤ 14 å¤©å‰çš„å¤©æ°£é å ±è³‡æ–™
-- DELETE FROM weather WHERE fetched_at < NOW() - INTERVAL '14 days';

-- =============================================================================
-- æœå°‹æŸ¥è©¢ç¯„ä¾‹
-- =============================================================================

-- ä½¿ç”¨è€…è¼¸å…¥åœ°é»žæœå°‹ï¼ˆæ”¯æ´ 2-6 å€‹å­—çš„æ¨¡ç³Šæœå°‹ï¼‰
-- SELECT id, full_name, county, district 
-- FROM location 
-- WHERE full_name LIKE '%æ°¸å’Œ%'
-- ORDER BY LENGTH(full_name), full_name;

-- =============================================================================
-- å¤©æ°£ç‹€æ³èˆ‡ Emoji æ˜ å°„åƒè€ƒ
-- =============================================================================

-- å¸¸è¦‹å¤©æ°£ç‹€æ³å°æ‡‰ emojiï¼š
-- "æ™´" â†’ "â˜€ï¸"
-- "å¤šé›²" â†’ "â˜ï¸"
-- "é™°" â†’ "â˜ï¸"
-- "çŸ­æš«é™£é›¨" â†’ "ðŸŒ¦ï¸"
-- "é™£é›¨" â†’ "ðŸŒ§ï¸"
-- "é›·é›¨" â†’ "â›ˆï¸"
-- "çŸ­æš«é™£é›¨æˆ–é›·é›¨" â†’ "ðŸŒ¦ï¸"
-- "é™£é›¨æˆ–é›·é›¨" â†’ "â›ˆï¸"
