# AGENT - 目前位置天氣查詢功能設計文件

## 文件概述
本文件提供給 AI Agent（如 Claude Code）作為實作「目前位置」天氣查詢功能的技術指南。

## 問題背景 (Why)

### 核心問題
WeaMind LINE Bot 的 Rich Menu 中「目前位置」按鈕目前是佔位功能，用戶點擊後只會收到「功能即將推出」的訊息。這個功能是用戶日常使用頻率很高的需求，需要優先實作。

### 用戶需求
- 用戶希望快速查詢當前所在位置的天氣資訊
- 不需要記憶或輸入地名，直接使用 GPS 位置
- 體驗應該直觀且快速

### 技術現狀
- ✅ Location table 已有全台所有行政區的經緯度資料
- ✅ LINE SDK v3 支援 LocationMessageContent 處理
- ✅ Rich Menu PostBack 事件處理系統已完整
- ✅ 天氣查詢與回應系統已完善

## 功能範圍 (What)

### 核心功能
1. **觸發機制**：用戶點擊 Rich Menu「目前位置」按鈕
2. **位置請求**：Bot 引導用戶分享當前位置
3. **距離計算**：計算用戶位置與各行政區的距離
4. **最近匹配**：找出最近的行政區
5. **天氣查詢**：查詢該行政區的天氣資訊
6. **結果回應**：回傳天氣資訊給用戶

### 技術邊界
- **範圍限制**：僅支援台灣地區（基於現有 location table）
- **精確度**：以行政區為單位，不支援更細緻的地理位置
- **權限要求**：需要用戶主動分享位置，無法自動取得

## 技術方案 (How)

### 架構設計

#### 1. 用戶體驗流程
```
用戶點擊「目前位置」→ Bot 請求分享位置 → 用戶分享 GPS 座標 → 
Bot 計算最近行政區 → 查詢天氣 → 回傳結果
```

#### 2. 事件處理流程
```python
# 流程概述
PostbackEvent (action=weather&type=current) 
→ handle_current_location_weather() 
→ 發送「請分享位置」訊息

LocationMessageContent Event
→ handle_location_message() 
→ 計算距離 → 找最近行政區 → 查詢天氣 → 回應
```

### 核心演算法

#### Haversine 距離計算
使用 Haversine 公式計算地球表面兩點間的距離（單位：公里）：

```python
def haversine_distance(lat1: float, lon1: float, lat2: float, lon2: float) -> float:
    """計算兩個經緯度座標間的距離（公里）"""
    # 地球半徑：6371 公里
    # 轉換為弧度 → 計算差值 → 應用 Haversine 公式
```

#### 最近行政區查找
```python
def find_nearest_location(user_lat: float, user_lon: float) -> Location:
    """找出距離用戶最近的行政區"""
    # 遍歷所有 location records
    # 計算與用戶位置的距離
    # 回傳距離最小的行政區
```

### 實作要點

#### 1. 事件處理器擴展
- 修改 `handle_current_location_weather()` 從佔位功能變為實際功能
- 新增 `LocationMessageContent` 事件處理器
- 整合現有的 `LocationService.parse_location_input()` 進行天氣查詢

#### 2. 訊息回應設計
- 第一次回應：「請分享您的位置」+ Quick Reply 位置按鈕
- 第二次回應：天氣資訊（整合現有格式）
- 錯誤處理：位置不在台灣、無法計算距離等

#### 3. 資料庫查詢最佳化
- 考慮 location table 的查詢效能
- 可能需要索引 latitude, longitude 欄位

## 技術限制與考量

### 已知限制
1. **地理範圍**：僅支援台灣地區（基於現有資料）
2. **精確度**：以行政區為單位，可能不夠精細
3. **使用者體驗**：需要兩次互動（點擊 + 分享位置）
4. **位置權限**：依賴用戶主動分享，無法強制

### 技術考量
1. **效能**：距離計算需要遍歷所有行政區（約 370 筆）
2. **錯誤處理**：用戶位置在台灣以外的情況
3. **資料一致性**：location table 的座標準確性
4. **並發處理**：多用戶同時使用的效能影響

### 安全考量
1. **隱私保護**：不儲存用戶的 GPS 座標
2. **資料驗證**：驗證接收到的座標格式
3. **錯誤訊息**：避免洩露系統內部資訊

## 重要共識與決策

### 設計決策
1. **方案選擇**：採用 PostBack + LINE 內建位置分享的方案
   - 優點：利用 LINE 原生功能，用戶體驗熟悉
   - 捨棄：LIFF + HTML5 Geolocation（複雜度較高）

2. **距離演算法**：使用 Haversine 公式
   - 原因：標準的地球表面距離計算方法
   - 精確度：適合行政區級別的匹配

3. **資料結構**：基於現有 location table
   - 現況：已有完整的台灣行政區經緯度資料
   - 限制：以行政區為最小單位

### 實作優先級
1. **高優先級**：核心功能實作（距離計算、事件處理）
2. **中優先級**：錯誤處理與邊界情況
3. **低優先級**：效能最佳化（索引、快取等）

### 測試策略
- 單元測試：Haversine 計算準確性
- 整合測試：完整用戶流程
- 邊界測試：台灣邊界、海外位置處理

## 預期效益

### 用戶體驗改善
- Rich Menu 功能完整度提升（4/6 → 5/6）
- 查詢天氣更直觀便利
- 減少地名輸入錯誤

### 技術價值
- 建立位置服務基礎架構
- 為未來地理相關功能奠定基礎
- 提升 LINE Bot 互動豐富度

## 未來擴展可能

1. **精確度提升**：支援更細緻的地理區劃
2. **範圍擴展**：支援其他國家或地區
3. **智慧推薦**：基於歷史位置提供個人化建議
4. **快取機制**：儲存常用位置，提升回應速度

---

**文件版本**：v1.0  
**建立日期**：2025-08-25  
**目標實作時間**：45-75 分鐘
