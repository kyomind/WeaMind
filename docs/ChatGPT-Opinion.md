看到你的報告了。先講重點：**你現在的做法可以上線，但有兩個明顯風險要立刻修正**：

1. 用「最近行政區代表點」會在邊界、狹長行政區產生系統性誤差。
2. 你設定的台灣經緯度邊界 **119.3°E 起跳**，**會排除金門（約 118.3°E）**，跟你寫的「支援離島」不一致。

# 我給你的務實改法（不重構、不上 GIS）

**目標：維持 Haversine 方案，但把錯誤率壓到可以接受，並善用 LINE 傳回的 address 當輔助。**

## 1) 先修「邊界矩形」錯誤（今天就能改）

* 經度下限改成 **118.0**（或更保守 117.8），確保 **金門**不被擋掉。
* 緯度範圍可維持 21.9–25.3；經度上限 122.2 也可略放。
* 保留你已有的「距離閾值 50 km」二層檢查，避免誤收海外。

## 2) 加一個「廉價的地址輔助」層（不引入地圖多邊形）

* LINE 位置訊息有 `address`，但格式雜；我們**只抽兩級**：縣市 + 區／鄉／鎮。
* 規則很簡單就好：

  * 正規化「臺/台」、移除郵遞區號與英文路段。
  * 用一張 **鄉鎮市區標準名對照表**（含別名）做映射，例如：「台中」→「臺中市」。
* **決策邏輯**（非常輕量）：

  1. 先跑你原本的 Haversine 最近鄉鎮（≈ 370 筆，< 15 ms）。
  2. 若 `address` 成功抽出「縣市 + 區鄉鎮」，而且與最近鄉鎮**同縣市**但不同鄉鎮 → **以地址結果為主**（這是最常見的邊界誤判修正）。
  3. 若最近距離 > 10 km（你自己定門檻）→ 優先採用地址解析結果，否則採最近點。
  4. 兩者皆無法決定 → 回覆「約略定位」（降低承諾），同時記錄用來後續觀察。

> 這套邏輯**不需要**多邊形，也不需要引入 GeoPandas；就靠一張字典表與幾個正則就能把邊界錯誤率壓低。

## 3) 微調距離閾值與回覆策略

* 50 km 當「台灣服務範圍」的外框 OK，但**作為最近點可信度判斷太鬆**。
* 建議加第二門檻：

  * **可信距離**：≤ 3–5 km → 直接採用最近點。
  * **可疑距離**：> 5 km → 啟用「地址優先」邏輯／或在回覆文案加「約略」。
* 這樣可以在東部、海岸、離島邊緣降低錯配感。

# 為什麼這樣最務實

| 選項                              | 變更量 | 風險             | 成效                       |
| --------------------------------- | ------ | ---------------- | -------------------------- |
| 只修邊界矩形                      | 最小   | 仍有邊界誤差     | 中等                       |
| 加「地址輔助」決策（上面第 2 點） | 小     | 需一份對照表     | 大幅降低誤配               |
| 引入行政區多邊形 PIP              | 中～大 | 新依賴、部署複雜 | 準確度最高但超出你現在節奏 |

# 你現在的文件裡，我同意與不同意的地方

* ✅ 同意：用 Haversine 做最近鄉鎮、資料量 300–400 筆、延遲 < 15 ms，很實際。
* ⚠️ 需修：矩形邊界設太緊，**金門被排除**；文件卻宣稱支援離島。
* ⚠️ 建議：把「地址」納入決策（至少做縣市層的 sanity check），邊界誤差最容易在這裡被撈回。

# 總結（硬結論）

* **先調整邊界下限到 118.0E**，今天就改。
* **立刻加「地址輔助」決策**：只抽縣市＋鄉鎮市區兩級，用對照表做映射；當最近點距離偏大或跨縣市時，採用地址結果。
* **保留你現有的 Haversine 主流程**，不進 GIS，也能把準確度拉一階。

要我就幫你生一個「鄉鎮市區標準名＋別名對照表（JSON）」和一段 30 行內的地址抽取函式，直接接到你現有的 `handle_location_weather_query` 裡。
