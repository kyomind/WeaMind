# WeaMind 天氣資料庫 Schema 設計分析

## 專案背景

基於 WeaMind PRD v1.0 的需求，我們需要設計天氣與行政區資料庫 Schema。本文件記錄了針對氣象局 API 資料結構的分析與最終的設計決策。

## 氣象局 API 資料分析

### API 基本特性
- **資料來源**：中央氣象署開放資料平台
- **資料集**：臺灣各縣市鄉鎮未來3天天氣預報 (D0047-001)
- **查詢限制**：單次最多可選取 5 個一級行政區
- **資料更新**：由 wea-data 微服務定期更新

### 資料結構特徵
```json
{
  "records": {
    "Locations": [
      {
        "LocationsName": "宜蘭縣",        // 一級行政區
        "Location": [
          {
            "LocationName": "宜蘭市",      // 二級行政區
            "Geocode": "10002010",         // 地理編碼
            "Latitude": "24.753707",       // 緯度
            "Longitude": "121.745083",     // 經度
            "WeatherElement": [...]        // 天氣要素陣列
          }
        ]
      }
    ]
  }
}
```

### 可用欄位清單
API 提供超過 30 個天氣相關欄位，包括：
- 基礎資料：溫度、降雨機率、天氣狀況
- 進階資料：體感溫度、舒適度指數、風速風向
- 區間資料：最高/最低溫度、UV指數等

## 技術挑戰分析

### 時間粒度不一致問題
不同天氣要素具有不同的時間粒度：

| 要素類型 | 時間粒度  | 範例                 |
| -------- | --------- | -------------------- |
| 溫度     | 逐小時    | 每小時一筆資料       |
| 降雨機率 | 3小時區間 | 18:00-21:00 一筆資料 |
| 天氣狀況 | 待確認    | 需進一步調查         |

**挑戰**：
1. 需要複雜的時間聚合邏輯
2. 不同粒度資料的同步問題
3. 複雜的資料庫 schema 設計
4. 查詢和聚合效能問題

## 解決方案比較

### 方案一：分別獲取結構化欄位

**優點**：
- 資料結構清晰，型別安全
- 容易驗證和處理
- 維護性佳，擴展容易
- 符合 DDD 設計原則

**缺點**：
- 時間粒度不一致問題複雜
- 需要複雜的聚合邏輯
- API 請求需指定多個欄位
- 資料庫 schema 設計複雜

### 方案二：WeatherDescription 字串解析

**優點**：
- 氣象局已完成時間聚合
- API 請求簡單（單一欄位）
- 避免時間粒度問題
- 直接對應 PRD 輸出格式

**缺點**：
- 需要字串解析邏輯
- 格式變動風險
- 解析錯誤處理複雜

## WeatherDescription 內容分析

### 實際資料範例
```
"晴。降雨機率20%。溫度攝氏29至30度。悶熱。偏東風 平均風速1-2級(每秒2公尺)。相對濕度81至83%。"
```

### 核心需求對應
根據 PRD 需求，我們只需要以下三個核心資訊：

| 需求     | 解析內容   | 用途               |
| -------- | ---------- | ------------------ |
| 天氣狀況 | "晴"       | Emoji 映射顯示     |
| 降雨機率 | "20%"      | 決定是否建議帶傘   |
| 溫度區間 | "29至30度" | 溫度顯示與穿衣建議 |

**捨棄內容**：
- "悶熱" - 主觀感受，非核心需求
- 風速風向 - 超出 v1.0 範圍
- 相對濕度 - 超出 v1.0 範圍

## 最終設計決策

### 採用方案：混合式架構

**資料獲取層面**：
- wea-data 微服務呼叫氣象局 API
- 僅獲取 `WeatherDescription` 欄位
- 進行字串解析和資料清理

**資料儲存層面**：
- 儲存解析後的結構化資料
- 保留原始字串作為備援
- 避免複雜的時間聚合邏輯

### Schema 設計原則

1. **單一資料來源**：WeatherDescription 欄位
2. **結構化儲存**：解析後分別儲存各欄位
3. **備援機制**：保留原始資料
4. **避免遷移**：一次設計到位

## 技術實作策略

### 資料流程
```
氣象局 API → wea-data → 字串解析 → 資料清理 → 結構化資料 → PostgreSQL
```

### 解析器設計
```python
def parse_weather_description(description: str) -> WeatherData:
    """
    解析天氣預報綜合描述字串
    
    輸入："晴。降雨機率20%。溫度攝氏29至30度。..."
    輸出：WeatherData(condition="晴", precipitation=20, min_temp=29, max_temp=30)
    """
    pass
```

### 錯誤處理策略
1. 正則表達式容錯處理
2. 解析失敗時的降級機制
3. 資料驗證與清理
4. 日誌記錄與監控

## 預期優勢

1. **避免資料庫遷移**：一次設計到位
2. **簡化架構**：避免複雜的時間聚合
3. **提升效能**：減少查詢複雜度
4. **符合需求**：完美對應 PRD 輸出格式
5. **降低維護成本**：單一資料來源，清晰的解析邏輯

## 下一步行動

1. 設計完整的資料庫 Schema
2. 實作 WeatherDescription 解析器
3. 建立資料驗證機制
4. 設計錯誤處理與監控
5. 建立 Alembic 遷移腳本

---

**決策日期**：2025-08-12  
**負責人**：WeaMind 開發團隊  
**相關文件**：
- `prd/weamind-prd-v1.md`
- `docs/Todo.md` (項目 21)
- `docs/weather_data_demo.json`
