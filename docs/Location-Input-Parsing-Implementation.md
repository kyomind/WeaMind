# 地點輸入解析功能實作說明

## 概述

實作了符合 PRD 規格的地點輸入解析功能，讓 LINE Bot 能夠理解用戶輸入的地名並進行智慧查詢。

## 功能特性

### 1. 輸入格式驗證
- **字數限制**：2-6個字符（符合PRD規格）
- **字符檢查**：僅接受中文字符
- **空白處理**：自動去除前後空白

### 2. 模糊查詢邏輯
- 使用 `county + district LIKE '%輸入內容%'` 進行查詢
- 支援部分匹配，例如：
  - `永和` → `新北市永和區`
  - `信義區` → `台北市信義區`、`基隆市信義區`

### 3. 結果處理策略（PRD規格）
| 結果數量 | 處理方式 | 用戶體驗 |
|---------|---------|---------|
| 1個 | 直接進入天氣查詢 | `找到了 新北市永和區，正在查詢天氣...` |
| 2-3個 | 提供選項讓用戶選擇 | 顯示選項清單 👉 |
| >3個 | 請求更具體輸入 | 建議加上「區」等後綴 |
| 0個 | 友善錯誤提示 | 建議檢查拼字 |

## 檔案結構

```
app/weather/
├── service.py          # 地點解析核心邏輯
├── models.py          # Location 資料模型（已存在）
└── __init__.py

app/line/
└── service.py         # 整合地點解析到 LINE Bot

tests/weather/
├── conftest.py        # 測試 fixtures
├── test_location_service.py  # 完整測試套件
└── __init__.py
```

## 核心實作

### LocationService 類別

```python
class LocationService:
    @staticmethod
    def validate_location_input(text: str) -> str:
        """驗證輸入格式"""

    @staticmethod
    def search_locations_by_name(session: Session, location_name: str) -> Sequence[Location]:
        """模糊查詢地點"""

    @staticmethod
    def parse_location_input(session: Session, text: str) -> tuple[Sequence[Location], str]:
        """解析用戶輸入並返回匹配結果與回應訊息"""
```

### LINE Bot 整合

修改了 `handle_message_event` 函數：
1. 接收用戶訊息
2. 解析為地點輸入
3. 根據解析結果回應用戶
4. 格式錯誤時顯示友善錯誤訊息
5. 系統異常時顯示通用錯誤訊息

## 測試覆蓋

### 測試案例設計
- ✅ **格式驗證測試**：有效輸入、字數限制、空輸入、非中文
- ✅ **查詢功能測試**：精確匹配、模糊匹配、多結果、無結果
- ✅ **解析邏輯測試**：單一結果、多選結果、過多結果、無結果、格式錯誤

### 測試統計
- **測試案例數**：10個
- **代碼覆蓋率**：100%
- **測試隔離**：每個測試後自動清理資料

## 部署後行為說明

### 重要改動
移除了原本的應聲蟲（echo）功能，現在 LINE Bot 專注於地點查詢：

- ✅ **所有輸入都經過地點解析處理**
- ✅ **格式錯誤時提供友善指引**
- ✅ **系統異常時顯示通用錯誤訊息**
- ❌ ~~不再有 echo 回退機制~~

### 目前階段限制
- **僅實作地點解析階段**，尚未整合實際天氣查詢
- 即使找到唯一地點，也只會顯示「正在查詢天氣...」提示訊息
- 需要後續與 wea-ai 服務整合才能提供真實天氣資料

### 完整回應行為表
| 輸入情況 | Bot 回應 | 狀態 |
|---------|---------|------|
| 有效地點(1個結果) | `找到了 {地點}，正在查詢天氣...` | ✅ 有回應 |
| 有效地點(2-3個結果) | 選項清單供用戶選擇 | ✅ 有回應 |
| 有效地點(>3個結果) | 請求更具體輸入的提示 | ✅ 有回應 |
| 有效地點(0個結果) | 找不到地點的錯誤訊息 | ✅ 有回應 |
| 格式錯誤輸入 | 格式要求說明訊息 | ✅ 有回應 |
| 系統異常 | 通用系統錯誤訊息 | ✅ 有回應 |

## 用戶體驗示例

### 成功案例
```
用戶輸入：永和
Bot回應：找到了 新北市永和區，正在查詢天氣...
```

### 多選案例
```
用戶輸入：信義區
Bot回應：😕 找到多個符合的地點，請選擇：
👉 台北市信義區
👉 基隆市信義區
```

### 錯誤處理
```
用戶輸入：abc
Bot回應：請輸入中文地名。

用戶輸入：中正
Bot回應：🤔 找到太多符合的地點了！請輸入更具體的地名，例如：
「中正區」而不是「中正」
```

## 技術細節

### 資料庫查詢優化
- 直接使用 `full_name` 欄位進行模糊查詢
- 利用 `full_name` 欄位的索引加速查詢
- `ORDER BY full_name` 確保結果一致性

### 異常處理策略
- **LocationParseError**：自定義異常處理格式錯誤
- **友善錯誤**：格式錯誤時提供具體指引
- **系統錯誤**：異常時顯示通用錯誤訊息，不再回退到 echo
- **日誌記錄**：詳細記錄解析過程和錯誤

### 程式碼品質
- 100% 類型註解覆蓋
- 符合專案 linting 規範（Ruff + Pyright）
- 完整的 docstring 文檔

## 下一步規劃

1. **用戶地點設定**：擴展 user schema 支援住家/公司地址
2. **查詢記錄**：實作最近查詢記錄功能
3. **Rich Menu**：設計快捷查詢介面
4. **天氣整合**：與 wea-ai 服務對接獲取實際天氣資料

## 測試執行

```bash
# 執行地點解析測試
uv run pytest tests/weather/test_location_service.py -v

# 檢查代碼品質
uv run ruff check .
uv run pyright .
```
